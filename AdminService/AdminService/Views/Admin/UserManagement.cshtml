@model List<User>

@{
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
    ViewData["Title"] = "Admin Panel";
}

<div class="container mt-4">
    <h2 class="text-center mb-4">Users List</h2>

    <!-- Add User & Search Bar -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <a href="@Url.Action("AddUser", "Admin")" class="btn btn-success">+ Add User</a>
        <input type="text" id="searchUser" class="form-control w-25" placeholder="Search User by User ID" style="border-color:black">
    </div>

    <!-- User Table -->
    <table class="table table-bordered table-striped mt-3" id="userTable" style="border-color:black">
        <thead class="thead-dark">
            <tr>
                <th>User ID</th>
                <th>User Name</th>
                <th>Email</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="userTableBody">
            @if (Model != null && Model.Any())
            {
                @foreach (var user in Model)
                {
                    <tr>
                        <td>@user.user_id</td>
                        <td>@user.name</td>
                        <td>@user.email</td>
                        <td>
                            <a href="@Url.Action("EditUser", "Admin", new { id = user.user_id })" class="btn btn-primary btn-sm">Edit</a>
                            <button class="btn btn-danger btn-sm deleteUser" data-userid="@user.user_id">Delete</button>
                        </td>
                    </tr>
                }
            }
            else
            {
                <tr id="noUsersRow">
                    <td colspan="4" class="text-center">No users found.</td>
                </tr>
            }
        </tbody>
    </table>
</div>

<!-- jQuery for AJAX -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    $(document).ready(function () {

        // Live Search Functionality
        $("#searchUser").on("input", function () {
            var userId = $(this).val().trim();

            if (userId === "") {
                location.reload(); // Reload page if input is empty
                return;
            }

            $.ajax({
                url: '@Url.Action("SearchUser", "Admin")',
                type: "GET",
                data: { user_id: userId },
                success: function (data) {
                    var tableBody = $("#userTableBody");
                    tableBody.empty(); // Clear table data

                    if (data.length > 0) {
                        $.each(data, function (index, user) {
                            tableBody.append(`
                                <tr>
                                    <td>${user.user_id}</td>
                                    <td>${user.name}</td>
                                    <td>${user.email}</td>
                                    <td>
                                        <a href="/Admin/EditUser/${user.user_id}" class="btn btn-primary btn-sm">Edit</a>
                                        <button class="btn btn-danger btn-sm deleteUser" data-userid="${user.user_id}">Delete</button>
                                    </td>
                                </tr>
                            `);
                        });
                    } else {
                        tableBody.append('<tr id="noUsersRow"><td colspan="4" class="text-center">No users found.</td></tr>');
                    }
                }
            });
        });

        // Delete User Confirmation
        $(document).on("click", ".deleteUser", function () {
            var userId = $(this).data("userid");

            if (confirm("Are you sure you want to delete this user?")) {
                $.ajax({
                    url: '/Admin/DeleteUser/' + userId,
                    type: "POST",
                    success: function (response) {
                        alert("✅ User deleted successfully!");
                        location.reload(); // Reload the page after successful deletion
                    },
                    error: function () {
                        alert("❌ Error deleting user. Please try again.");
                    }
                });
            }
        });
    });
</script>
